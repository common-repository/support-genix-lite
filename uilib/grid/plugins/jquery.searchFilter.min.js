jQuery.fn.searchFilter=function(fields,options){function SearchFilter(jQ,fields,options){this.$=jQ;this.add=function(i){if(i==null)jQ.find(".ui-add-last").click();else jQ.find(".sf:eq("+i+") .ui-add").click();return this};this.del=function(i){if(i==null)jQ.find(".sf:last .ui-del").click();else jQ.find(".sf:eq("+i+") .ui-del").click();return this};this.search=function(e){jQ.find(".ui-search").click();return this};this.reset=function(o){if(o===undefined)o=false;jQ.find(".ui-reset").trigger("click",[o]);return this};this.close=function(){jQ.find(".ui-closer").click();return this};if(fields!=null){function hover(){jQuery(this).toggleClass("ui-state-hover");return false}function active(e){jQuery(this).toggleClass("ui-state-active",e.type=="mousedown");return false}function buildOpt(value,text){return"<option value='"+value+"'>"+text+"</option>"}function buildSel(className,options,isHidden){return"<select class='"+className+"'"+(isHidden?" style='display:none;'":"")+">"+options+"</select>"}function initData(selector,fn){var jElem=jQ.find("tr.sf td.data "+selector);if(jElem[0]!=null)fn(jElem)}function bindDataEvents(selector,events){var jElem=jQ.find("tr.sf td.data "+selector);if(jElem[0]!=null){jQuery.each(events,function(){if(this.data!=null)jElem.bind(this.type,this.data,this.fn);else jElem.bind(this.type,this.fn)})}}var opts=jQuery.extend({},jQuery.fn.searchFilter.defaults,options);var highest_late_setup=-1;var gOps_html="";jQuery.each(opts.groupOps,function(){gOps_html+=buildOpt(this.op,this.text)});gOps_html="<select name='groupOp'>"+gOps_html+"</select>";jQ.html("").addClass("ui-searchFilter").append("<div class='ui-widget-overlay' style='z-index: -1'>&#160;</div><table class='ui-widget-content ui-corner-all'><thead><tr><td colspan='5' class='ui-widget-header ui-corner-all' style='line-height: 18px;'><div class='ui-closer ui-state-default ui-corner-all ui-helper-clearfix' style='float: right;'><span class='ui-icon ui-icon-close'></span></div>"+opts.windowTitle+"</td></tr></thead><tbody><tr class='sf'><td class='fields'></td><td class='ops'></td><td class='data'></td><td><div class='ui-del ui-state-default ui-corner-all'><span class='ui-icon ui-icon-minus'></span></div></td><td><div class='ui-add ui-state-default ui-corner-all'><span class='ui-icon ui-icon-plus'></span></div></td></tr><tr><td colspan='5' class='divider'><hr class='ui-widget-content' style='margin:1px'/></td></tr></tbody><tfoot><tr><td colspan='3'><span class='ui-reset ui-state-default ui-corner-all' style='display: inline-block; float: left;'><span class='ui-icon ui-icon-arrowreturnthick-1-w' style='float: left;'></span><span style='line-height: 18px; padding: 0 7px 0 3px;'>"+opts.resetText+"</span></span><span class='ui-search ui-state-default ui-corner-all' style='display: inline-block; float: right;'><span class='ui-icon ui-icon-search' style='float: left;'></span><span style='line-height: 18px; padding: 0 7px 0 3px;'>"+opts.searchText+"</span></span><span class='matchText'>"+opts.matchText+"</span> "+gOps_html+" <span class='rulesText'>"+opts.rulesText+"</span></td><td>&#160;</td><td><div class='ui-add-last ui-state-default ui-corner-all'><span class='ui-icon ui-icon-plusthick'></span></div></td></tr></tfoot></table>");var jRow=jQ.find("tr.sf");var jFields=jRow.find("td.fields");var jOps=jRow.find("td.ops");var jData=jRow.find("td.data");var default_ops_html="";jQuery.each(opts.operators,function(){default_ops_html+=buildOpt(this.op,this.text)});default_ops_html=buildSel("default",default_ops_html,true);jOps.append(default_ops_html);var default_data_html="<input type='text' class='default' style='display:none;' />";jData.append(default_data_html);var fields_html="";var has_custom_ops=false;var has_custom_data=false;jQuery.each(fields,function(i){var field_num=i;fields_html+=buildOpt(this.itemval,this.text);if(this.ops!=null){has_custom_ops=true;var custom_ops="";jQuery.each(this.ops,function(){custom_ops+=buildOpt(this.op,this.text)});custom_ops=buildSel("field"+field_num,custom_ops,true);jOps.append(custom_ops)}if(this.dataUrl!=null){if(i>highest_late_setup)highest_late_setup=i;has_custom_data=true;var dEvents=this.dataEvents;var iEvent=this.dataInit;var bs=this.buildSelect;jQuery.ajax(jQuery.extend({url:this.dataUrl,complete:function(data){var $d;if(bs!=null)$d=jQuery("<div />").append(bs(data));else $d=jQuery("<div />").append(data.responseText);$d.find("select").addClass("field"+field_num).hide();jData.append($d.html());if(iEvent)initData(".field"+i,iEvent);if(dEvents)bindDataEvents(".field"+i,dEvents);if(i==highest_late_setup){jQ.find("tr.sf td.fields select[name='field']").change()}}},opts.ajaxSelectOptions))}else if(this.dataValues!=null){has_custom_data=true;var custom_data="";jQuery.each(this.dataValues,function(){custom_data+=buildOpt(this.value,this.text)});custom_data=buildSel("field"+field_num,custom_data,true);jData.append(custom_data)}else if(this.dataEvents!=null||this.dataInit!=null){has_custom_data=true;var custom_data="<input type='text' class='field"+field_num+"' />";jData.append(custom_data)}if(this.dataInit!=null&&i!=highest_late_setup)initData(".field"+i,this.dataInit);if(this.dataEvents!=null&&i!=highest_late_setup)bindDataEvents(".field"+i,this.dataEvents)});fields_html="<select name='field'>"+fields_html+"</select>";jFields.append(fields_html);var jFSelect=jFields.find("select[name='field']");if(has_custom_ops)jFSelect.change(function(e){var index=e.target.selectedIndex;var td=jQuery(e.target).parents("tr.sf").find("td.ops");td.find("select").removeAttr("name").hide();var jElem=td.find(".field"+index);if(jElem[0]==null)jElem=td.find(".default");jElem.attr("name","op").show();return false});else jOps.find(".default").attr("name","op").show();if(has_custom_data)jFSelect.change(function(e){var index=e.target.selectedIndex;var td=jQuery(e.target).parents("tr.sf").find("td.data");td.find("select,input").removeClass("vdata").hide();var jElem=td.find(".field"+index);if(jElem[0]==null)jElem=td.find(".default");jElem.show().addClass("vdata");return false});else jData.find(".default").show().addClass("vdata");if(has_custom_ops||has_custom_data)jFSelect.change();jQ.find(".ui-state-default").hover(hover,hover).mousedown(active).mouseup(active);jQ.find(".ui-closer").click(function(e){opts.onClose(jQuery(jQ.selector));return false});jQ.find(".ui-del").click(function(e){var row=jQuery(e.target).parents(".sf");if(row.siblings(".sf").length>0){if(opts.datepickerFix===true&&jQuery.fn.datepicker!==undefined)row.find(".hasDatepicker").datepicker("destroy");row.remove()}else{row.find("select[name='field']")[0].selectedIndex=0;row.find("select[name='op']")[0].selectedIndex=0;row.find(".data input").val("");row.find(".data select").each(function(){this.selectedIndex=0});row.find("select[name='field']").change(function(event){event.stopPropagation()})}return false});jQ.find(".ui-add").click(function(e){var row=jQuery(e.target).parents(".sf");var newRow=row.clone(true).insertAfter(row);newRow.find(".ui-state-default").removeClass("ui-state-hover ui-state-active");if(opts.clone){newRow.find("select[name='field']")[0].selectedIndex=row.find("select[name='field']")[0].selectedIndex;var stupid_browser=newRow.find("select[name='op']")[0]==null;if(!stupid_browser)newRow.find("select[name='op']").focus()[0].selectedIndex=row.find("select[name='op']")[0].selectedIndex;var jElem=newRow.find("select.vdata");if(jElem[0]!=null)jElem[0].selectedIndex=row.find("select.vdata")[0].selectedIndex}else{newRow.find(".data input").val("");newRow.find("select[name='field']").focus()}if(opts.datepickerFix===true&&jQuery.fn.datepicker!==undefined){row.find(".hasDatepicker").each(function(){var settings=jQuery.data(this,"datepicker").settings;newRow.find("#"+this.id).unbind().removeAttr("id").removeClass("hasDatepicker").datepicker(settings)})}newRow.find("select[name='field']").change(function(event){event.stopPropagation()});return false});jQ.find(".ui-search").click(function(e){var ui=jQuery(jQ.selector);var ruleGroup;var group_op=ui.find("select[name='groupOp'] :selected").val();if(!opts.stringResult){ruleGroup={groupOp:group_op,rules:[]}}else{ruleGroup='{"groupOp":"'+group_op+'","rules":['}ui.find(".sf").each(function(i){var tField=jQuery(this).find("select[name='field'] :selected").val();var tOp=jQuery(this).find("select[name='op'] :selected").val();var tData=jQuery(this).find("input.vdata,select.vdata :selected").val();tData+="";if(!opts.stringResult){ruleGroup.rules.push({field:tField,op:tOp,data:tData})}else{tData=tData.replace(/\\/g,"\\\\").replace(/\"/g,'\\"');if(i>0)ruleGroup+=",";ruleGroup+='{"field":"'+tField+'",';ruleGroup+='"op":"'+tOp+'",';ruleGroup+='"data":"'+tData+'"}'}});if(opts.stringResult)ruleGroup+="]}";opts.onSearch(ruleGroup);return false});jQ.find(".ui-reset").click(function(e,op){var ui=jQuery(jQ.selector);ui.find(".ui-del").click();ui.find("select[name='groupOp']")[0].selectedIndex=0;opts.onReset(op);return false});jQ.find(".ui-add-last").click(function(){var row=jQuery(jQ.selector+" .sf:last");var newRow=row.clone(true).insertAfter(row);newRow.find(".ui-state-default").removeClass("ui-state-hover ui-state-active");newRow.find(".data input").val("");newRow.find("select[name='field']").focus();if(opts.datepickerFix===true&&jQuery.fn.datepicker!==undefined){row.find(".hasDatepicker").each(function(){var settings=jQuery.data(this,"datepicker").settings;newRow.find("#"+this.id).unbind().removeAttr("id").removeClass("hasDatepicker").datepicker(settings)})}newRow.find("select[name='field']").change(function(event){event.stopPropagation()});return false});this.setGroupOp=function(setting){selDOMobj=jQ.find("select[name='groupOp']")[0];var indexmap={},l=selDOMobj.options.length,i;for(i=0;i<l;i++){indexmap[selDOMobj.options[i].value]=i}selDOMobj.selectedIndex=indexmap[setting];jQuery(selDOMobj).change(function(event){event.stopPropagation()})};this.setFilter=function(settings){var o=settings["sfref"],filter=settings["filter"];var fields=[],i,j,l,lj,li,valueindexmap={};selDOMobj=o.find("select[name='field']")[0];for(i=0,l=selDOMobj.options.length;i<l;i++){valueindexmap[selDOMobj.options[i].value]={index:i,ops:{}};fields.push(selDOMobj.options[i].value)}for(i=0,li=fields.length;i<li;i++){selDOMobj=o.find(".ops > select[class='field"+i+"']")[0];if(selDOMobj){for(j=0,lj=selDOMobj.options.length;j<lj;j++){valueindexmap[fields[i]]["ops"][selDOMobj.options[j].value]=j}}selDOMobj=o.find(".data > select[class='field"+i+"']")[0];if(selDOMobj){valueindexmap[fields[i]]["data"]={};for(j=0,lj=selDOMobj.options.length;j<lj;j++){valueindexmap[fields[i]]["data"][selDOMobj.options[j].value]=j}}}var fieldvalue,fieldindex,opindex,datavalue,dataindex;fieldvalue=filter["field"];if(valueindexmap[fieldvalue]){fieldindex=valueindexmap[fieldvalue]["index"]}if(fieldindex!=null){opindex=valueindexmap[fieldvalue]["ops"][filter["op"]];if(opindex===undefined){for(i=0,li=options.operators.length;i<li;i++){if(options.operators[i].op==filter.op){opindex=i;break}}}datavalue=filter["data"];if(valueindexmap[fieldvalue]["data"]==null){dataindex=-1}else{dataindex=valueindexmap[fieldvalue]["data"][datavalue]}}if(fieldindex!=null&&opindex!=null&&dataindex!=null){o.find("select[name='field']")[0].selectedIndex=fieldindex;o.find("select[name='field']").change();o.find("select[name='op']")[0].selectedIndex=opindex;o.find("input.vdata").val(datavalue);o=o.find("select.vdata")[0];if(o){o.selectedIndex=dataindex}return true}else{return false}}}}return new SearchFilter(this,fields,options)};jQuery.fn.searchFilter.version="1.2.9";jQuery.fn.searchFilter.defaults={clone:true,datepickerFix:true,onReset:function(data){alert("Reset Clicked. Data Returned: "+data)},onSearch:function(data){alert("Search Clicked. Data Returned: "+data)},onClose:function(jElem){jElem.hide()},groupOps:[{op:"AND",text:"all"},{op:"OR",text:"any"}],operators:[{op:"eq",text:"is equal to"},{op:"ne",text:"is not equal to"},{op:"lt",text:"is less than"},{op:"le",text:"is less or equal to"},{op:"gt",text:"is greater than"},{op:"ge",text:"is greater or equal to"},{op:"in",text:"is in"},{op:"ni",text:"is not in"},{op:"bw",text:"begins with"},{op:"bn",text:"does not begin with"},{op:"ew",text:"ends with"},{op:"en",text:"does not end with"},{op:"cn",text:"contains"},{op:"nc",text:"does not contain"}],matchText:"match",rulesText:"rules",resetText:"Reset",searchText:"Search",stringResult:true,windowTitle:"Search Rules",ajaxSelectOptions:{}};